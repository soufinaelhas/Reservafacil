// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                        String    @id @default(uuid())
  email                     String    @unique
  passwordHash              String    @map("password_hash")
  businessName              String    @map("business_name")
  businessSlug              String    @unique @map("business_slug")
  businessCategory          String?   @map("business_category")
  businessDescription       String?   @map("business_description") @db.Text
  businessAddress           String?   @map("business_address") @db.Text
  businessPhone             String?   @map("business_phone")
  businessEmail             String?   @map("business_email")
  logoUrl                   String?   @map("logo_url") @db.Text
  coverPhotoUrl             String?   @map("cover_photo_url") @db.Text
  timezone                  String    @default("Europe/Madrid")
  subscriptionTier          String    @default("basic") @map("subscription_tier")
  subscriptionStatus        String    @default("active") @map("subscription_status")
  stripeCustomerId          String?   @map("stripe_customer_id")
  stripeAccountId           String?   @map("stripe_account_id")
  emailVerified             Boolean   @default(false) @map("email_verified")
  emailVerificationToken    String?   @map("email_verification_token")
  passwordResetToken        String?   @map("password_reset_token")
  passwordResetExpires      DateTime? @map("password_reset_expires")
  createdAt                 DateTime  @default(now()) @map("created_at")
  updatedAt                 DateTime  @updatedAt @map("updated_at")

  // Relations
  services      Service[]
  availability  Availability[]
  breaks        Break[]
  specialDates  SpecialDate[]
  customers     Customer[]
  bookings      Booking[]
  transactions  Transaction[]
  auditLogs     AuditLog[]
  settings      Settings?

  @@map("users")
}

model Service {
  id                 String   @id @default(uuid())
  userId             String   @map("user_id")
  name               String
  description        String?  @db.Text
  durationMinutes    Int      @map("duration_minutes")
  price              Decimal  @db.Decimal(10, 2)
  bufferTimeMinutes  Int      @default(0) @map("buffer_time_minutes")
  category           String?
  depositRequired    Boolean  @default(false) @map("deposit_required")
  depositAmount      Decimal? @db.Decimal(10, 2) @map("deposit_amount")
  depositPercentage  Int?     @map("deposit_percentage")
  maxAdvanceDays     Int      @default(90) @map("max_advance_days")
  minAdvanceHours    Int      @default(2) @map("min_advance_hours")
  imageUrl           String?  @map("image_url") @db.Text
  isActive           Boolean  @default(true) @map("is_active")
  displayOrder       Int      @default(0) @map("display_order")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@map("services")
}

model Availability {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  dayOfWeek   Int      @map("day_of_week") // 0=Sunday, 1=Monday, etc.
  startTime   String   @map("start_time") // TIME stored as string "HH:MM"
  endTime     String   @map("end_time")
  isAvailable Boolean  @default(true) @map("is_available")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dayOfWeek])
  @@map("availability")
}

model Break {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  dayOfWeek Int      @map("day_of_week")
  startTime String   @map("start_time")
  endTime   String   @map("end_time")
  label     String?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("breaks")
}

model SpecialDate {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  startDate   DateTime @map("start_date") @db.Date
  endDate     DateTime @map("end_date") @db.Date
  reason      String?
  isAvailable Boolean  @default(false) @map("is_available") // false = blocked
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("special_dates")
}

model Customer {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  name          String
  email         String
  phone         String
  notes         String?  @db.Text
  isBlocked     Boolean  @default(false) @map("is_blocked")
  totalBookings Int      @default(0) @map("total_bookings")
  totalRevenue  Decimal  @default(0) @db.Decimal(10, 2) @map("total_revenue")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@unique([userId, email])
  @@map("customers")
}

model Booking {
  id                     String    @id @default(uuid())
  userId                 String    @map("user_id")
  serviceId              String?   @map("service_id")
  customerId             String?   @map("customer_id")
  customerName           String    @map("customer_name")
  customerEmail          String    @map("customer_email")
  customerPhone          String    @map("customer_phone")
  customerNotes          String?   @map("customer_notes") @db.Text
  bookingDate            DateTime  @map("booking_date") @db.Date
  bookingTime            String    @map("booking_time") // TIME as string "HH:MM"
  endTime                String    @map("end_time")
  durationMinutes        Int       @map("duration_minutes")
  price                  Decimal   @db.Decimal(10, 2)
  status                 String    @default("confirmed") // confirmed, cancelled, completed, no_show
  paymentStatus          String    @default("unpaid") @map("payment_status") // unpaid, paid, refunded
  paymentAmount          Decimal?  @db.Decimal(10, 2) @map("payment_amount")
  stripePaymentIntentId  String?   @map("stripe_payment_intent_id")
  cancellationReason     String?   @map("cancellation_reason") @db.Text
  cancelledAt            DateTime? @map("cancelled_at")
  cancelledBy            String?   @map("cancelled_by") // customer, business, system
  reminderSent           Boolean   @default(false) @map("reminder_sent")
  reminderSentAt         DateTime? @map("reminder_sent_at")
  confirmationSent       Boolean   @default(false) @map("confirmation_sent")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  service      Service?      @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  customer     Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)
  transactions Transaction[]

  @@map("bookings")
}

model Settings {
  id                          String   @id @default(uuid())
  userId                      String   @unique @map("user_id")
  bookingConfirmation         String   @default("automatic") @map("booking_confirmation") // automatic, manual
  cancellationPolicy          String?  @map("cancellation_policy") @db.Text
  cancellationWindowHours     Int      @default(24) @map("cancellation_window_hours")
  allowSameDayBookings        Boolean  @default(true) @map("allow_same_day_bookings")
  timeSlotInterval            Int      @default(30) @map("time_slot_interval") // minutes
  emailNotifications          Boolean  @default(true) @map("email_notifications")
  newBookingNotifications     Boolean  @default(true) @map("new_booking_notifications")
  cancellationNotifications   Boolean  @default(true) @map("cancellation_notifications")
  paymentNotifications        Boolean  @default(true) @map("payment_notifications")
  dailySummaryEnabled         Boolean  @default(true) @map("daily_summary_enabled")
  dailySummaryTime            String   @default("08:00:00") @map("daily_summary_time")
  customerReminderHours       Int      @default(24) @map("customer_reminder_hours")
  customerConfirmationEmail   Boolean  @default(true) @map("customer_confirmation_email")
  customEmailMessage          String?  @map("custom_email_message") @db.Text
  createdAt                   DateTime @default(now()) @map("created_at")
  updatedAt                   DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("settings")
}

model Transaction {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  bookingId      String?  @map("booking_id")
  amount         Decimal  @db.Decimal(10, 2)
  stripeFee      Decimal? @db.Decimal(10, 2) @map("stripe_fee")
  platformFee    Decimal? @db.Decimal(10, 2) @map("platform_fee")
  netAmount      Decimal? @db.Decimal(10, 2) @map("net_amount")
  currency       String   @default("EUR")
  stripeChargeId String?  @map("stripe_charge_id")
  status         String? // succeeded, failed, refunded
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  @@map("transactions")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String // created, updated, deleted, cancelled
  entityType String   @map("entity_type") // booking, service, customer
  entityId   String?  @map("entity_id")
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent") @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}
